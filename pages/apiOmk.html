<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>apiOmk — Lire & écrire avec l’API Omeka S</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;          /* slate-900 */
      --fg: #e2e8f0;          /* slate-200 */
      --muted: #94a3b8;       /* slate-400 */
      --accent: #22c55e;      /* green-500 */
      --accent-2: #ef4444;    /* red-500 */
      --card: #111827;        /* gray-900 */
      --border: #1f2937;      /* gray-800 */
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: var(--bg); color: var(--fg);
      display: grid; grid-template-rows: auto 1fr auto;
    }
    header, footer { padding: 1rem clamp(1rem, 3vw, 2rem); background: var(--card); border-bottom: 1px solid var(--border); }
    footer { border-top: 1px solid var(--border); border-bottom: none; }
    h1 { margin: 0; font-size: clamp(1.1rem, 2.8vw, 1.6rem); }
    main { padding: 1rem clamp(1rem, 3vw, 2rem); display: grid; gap: 1rem; }

    .grid { display: grid; gap: .75rem; }
    .grid-2 { grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid-2 { grid-template-columns: 1fr 1fr; } }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: .6rem; padding: 1rem; }
    label { font-size: .9rem; color: var(--muted); }
    input, select, button, textarea { font: inherit; }
    input[type="text"], input[type="number"], textarea {
      width: 100%; padding: .55rem .7rem; color: var(--fg); background: #0b1220; border: 1px solid var(--border); border-radius: .5rem;
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: .6rem; }
    .actions { display: flex; gap: .5rem; flex-wrap: wrap; }
    button { padding: .5rem .8rem; border: 1px solid var(--border); border-radius: .5rem; background: #0b1220; color: var(--fg); cursor: pointer; }
    button.primary { background: #052e1b; border-color: #064e3b; color: #bbf7d0; }
    button.warn { background: #3b0a0a; border-color: #7f1d1d; color: #fecaca; }
    button:disabled { opacity: .6; cursor: not-allowed; }

    ul#listeEtudiants { list-style: none; padding: 0; margin: 0; display: grid; gap: .4rem; }
    ul#listeEtudiants li { display: flex; align-items: center; justify-content: space-between; gap: .6rem; padding: .6rem .7rem; background: #0b1220; border: 1px solid var(--border); border-radius: .5rem; }
    .li-title { font-weight: 600; }

    pre { max-height: 240px; overflow: auto; background: #0b1220; padding: .75rem; border-radius: .5rem; border: 1px solid var(--border); }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>Lire & écrire avec l’API Omeka S — <span class="muted">apiOmk.html</span></h1>
  </header>

  <main class="grid">
    <!-- Panneau Connexion / Contexte -->
    <section class="card grid">
      <div class="row">
        <div>
          <label for="baseUrl">Base Omeka S (URL)</label>
          <input id="baseUrl" type="text" value="http://localhost/omk_thyp_25-26" />
        </div>
        <div>
          <label for="classId">resource_class_id (liste)</label>
          <input id="classId" type="number" value="94" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="ec">Unité d’enseignement (fup8:hasEC)</label>
          <input id="ec" type="text" placeholder="Ex. Langage du web" />
        </div>
        <div>
          <label for="dateEvt">Date/heure de l’événement</label>
          <input id="dateEvt" type="text" />
        </div>
      </div>
      <div class="actions">
        <button id="btnCharger" class="primary">Charger la liste</button>
        <button id="btnMaintenant">Maintenant</button>
        <span id="userInfo" class="muted">Vérification de l’utilisateur…</span>
      </div>
    </section>

    <!-- Liste des étudiants (items) -->
    <section class="card grid">
      <div class="actions" style="justify-content: space-between;">
        <strong>Étudiants</strong>
        <span id="count" class="muted"></span>
      </div>
      <ul id="listeEtudiants"></ul>
    </section>

    <!-- Résultats / retours API -->
    <section class="card grid-2 grid">
      <div class="grid">
        <strong>Requête (GET items)</strong>
        <pre id="reqView" class="muted"></pre>
      </div>
      <div class="grid">
        <strong>Résultat (création d’événement)</strong>
        <pre id="resultCrea" class="muted"></pre>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Présences THYP — Démo API OMK</p>
  </footer>

  <script type="module">
    // --- Imports (doivent exister dans ./modules/) ---
    import { auth } from './modules/auth.js';
    import { pa } from './modules/authParams.js';

    // --- Initialisation ---
    const a = new auth(pa);

    const $ = (sel) => document.querySelector(sel);
    const baseUrlEl = $('#baseUrl');
    const classIdEl = $('#classId');
    const ecEl = $('#ec');
    const dateEvtEl = $('#dateEvt');
    const userInfoEl = $('#userInfo');
    const reqViewEl = $('#reqView');
    const countEl = $('#count');

    // Remplir la date par défaut
    const setNow = () => {
      const now = new Date();
      // ISO 8601 pour la compatibilité serveur, mais on affiche lisible
      dateEvtEl.value = now.toISOString();
    };
    setNow();

    $('#btnMaintenant').addEventListener('click', setNow);

    // Afficher l'utilisateur connecté (via votre module auth)
    a.getUser((u) => {
      const label = u?.name || u?.email || JSON.stringify(u) || 'inconnu';
      userInfoEl.textContent = `Utilisateur connecté : ${label}`;
    });

    // Charger la liste des items (ex. étudiants) d'une classe
    async function chargerListe() {
      const base = baseUrlEl.value.replace(/\/$/, '');
      const classId = Number(classIdEl.value || 0);
      const url = `${base}/api/items?resource_class_id=${classId}`;
      reqViewEl.textContent = url;

      $('#listeEtudiants').innerHTML = '';
      countEl.textContent = '';

      try {
        const data = await d3.json(url);
        countEl.textContent = `${data.length} item(s)`;

        const li = d3
          .select('#listeEtudiants')
          .selectAll('li')
          .data(data, (d) => d['o:id'])
          .enter()
          .append('li');

        li.append('span').attr('class', 'li-title').text((d) => d['o:title']);

        const btns = li.append('span').attr('class', 'actions');

        btns
          .append('button')
          .attr('class', 'primary')
          .text('présent')
          .on('click', (event, d) => creerPresence(d, false));

        btns
          .append('button')
          .attr('class', 'warn')
          .text('absent')
          .on('click', (event, d) => creerPresence(d, true));
      } catch (err) {
        countEl.textContent = 'Erreur de chargement';
        console.error(err);
        reqViewEl.textContent += "\n\n" + (err?.message || err);
      }
    }

    $('#btnCharger').addEventListener('click', chargerListe);

    // Fonction utilitaire : construit le payload simplifié attendu par votre wrapper a.omk.createItem
    function buildEventPayload(etudiantItem, absent = false) {
      const titre = `${absent ? 'Absence' : 'Présence'} de ${etudiantItem['o:title']} — ${new Date(dateEvtEl.value || new Date()).toLocaleString()}`;
      const payload = {};

      // Selon votre wrapper, ces clefs en termes sont acceptées et mappées côté client en JSON-LD Omeka S.
      payload['o:resource_class'] = 'dctype:Event';
      payload['dcterms:title'] = titre;
      payload['dcterms:valid'] = dateEvtEl.value || new Date().toISOString();

      // Liez l'UE si fournie (valeur littérale simple)
      const ec = ecEl.value?.trim();
      if (ec) payload['fup8:hasEC'] = ec;

      // Relation vers l'étudiant (ressource)
      // Votre wrapper accepte le format { rid: <o:id> } pour les relations de ressource.
      payload['fup8:hasEtudiant'] = { rid: etudiantItem['o:id'] };

      // Vous pouvez ajouter d'autres propriétés ici (template, etc.) si votre wrapper les supporte.
      // ex: payload['o:resource_template'] = 'Présence';

      return payload;
    }

    // Création d'un événement de présence/absence
    function creerPresence(etudiantItem, absent = false) {
      const body = buildEventPayload(etudiantItem, absent);
      // Appel via votre client Omeka S (wrapper)
      a.omk.createItem(body, (retour) => {
        // Affiche la réponse JSON brute
        $('#resultCrea').textContent = JSON.stringify(retour, null, 2);
      });
    }

    // Charger automatiquement au premier affichage
    chargerListe();
  </script>
</body>
</html>
